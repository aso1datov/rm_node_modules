#!/bin/bash

DRY_RUN=false
VERBOSE=false
EXCLUDE_PATHS=()

show_help() {
    echo -e "\033[1m–£–¥–∞–ª–µ–Ω–∏–µ node_modules\033[0m"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–æ–ø—Ü–∏–∏]"
    echo ""
    echo -e "\033[1m–û–ø—Ü–∏–∏:\033[0m"
    echo "  --dry-run       –¢–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ (–Ω–µ —É–¥–∞–ª—è—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏)"
    echo "  -v, --verbose   –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã –ø–∞–ø–æ–∫)"
    echo "  --exclude LIST  –ò—Å–∫–ª—é—á–∏—Ç—å –ø–∞–ø–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)"
    echo "  -h, --help      –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo -e "\033[1m–ü—Ä–∏–º–µ—Ä—ã:\033[0m"
    echo "  $0 --dry-run --verbose"
    echo "  $0 --exclude \"important,test dir\""
    echo "  $0 -v --exclude \"project alpha\""
    exit 0
}

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        -v|--verbose)
            VERBOSE=true
            ;;
        --exclude)
            shift
            while IFS= read -r -d ',' path; do
                cleaned_path=$(echo "$path" | xargs)
                [[ -n "$cleaned_path" ]] && EXCLUDE_PATHS+=("$cleaned_path")
            done <<< "$1,"
            ;;
        *)
            echo -e "\033[31m–û—à–∏–±–∫–∞: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1\033[0m"
            echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ $0 --help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø—Ä–∞–≤–∫–∏"
            exit 1
            ;;
    esac
    shift
done

should_exclude() {
    local dir="$1"
    for pattern in "${EXCLUDE_PATHS[@]}"; do
        if [[ "$dir" == *"$pattern"* ]]; then
            $VERBOSE && echo "‚ÑπÔ∏è –ò—Å–∫–ª—é—á–µ–Ω–æ: '$dir' (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —à–∞–±–ª–æ–Ω–æ–º: '$pattern')"
            return 0
        fi
    done
    return 1
}

echo "üîç –ü–æ–∏—Å–∫ –ø–∞–ø–æ–∫ node_modules..."

dirs=()
while IFS= read -r -d $'\0' dir; do
    if ! should_exclude "$dir"; then
        dirs+=("$dir")
    fi
done < <(find . -name "node_modules" -type d -prune -print0)

count=${#dirs[@]}

if [ "$count" -eq 0 ]; then
    echo "‚ÑπÔ∏è –ü–∞–ø–æ–∫ node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
    exit 0
fi

echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–∞–ø–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: $count"

if $DRY_RUN; then
    echo "üöÄ –†–µ–∂–∏–º dry-run (–Ω–∏–∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã)"
    echo "----------------------------------------"
    for dir in "${dirs[@]}"; do
        echo "[dry-run] –ù–∞–π–¥–µ–Ω–æ: '$dir'"
        if $VERBOSE; then
            du -sh "$dir" | awk '{print "  –†–∞–∑–º–µ—Ä: "$1}'
        fi
    done
    echo "----------------------------------------"
    echo "‚ÑπÔ∏è –í —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –±—ã–ª–æ –±—ã —É–¥–∞–ª–µ–Ω–æ: $count –ø–∞–ø–æ–∫"
else
    echo "üóëÔ∏è –ù–∞—á–∏–Ω–∞—é —É–¥–∞–ª–µ–Ω–∏–µ..."
    echo "----------------------------------------"

    deleted=0
    total_size=0

    for dir in "${dirs[@]}"; do
        echo "–£–¥–∞–ª—è—é: '$dir'"
        if $VERBOSE; then
            size=$(du -sh "$dir" | awk '{print $1}')
            echo "  –†–∞–∑–º–µ—Ä: $size"
            total_size=$((total_size + $(du -s "$dir" | awk '{print $1}')))
        fi

        rm -rf "$dir"

        ((deleted++))
        echo "–ü—Ä–æ–≥—Ä–µ—Å—Å: $deleted/$count"
        echo "----------------------------------------"
    done

    echo "‚ú® –ì–æ—Ç–æ–≤–æ!"
    echo "–£–¥–∞–ª–µ–Ω–æ –ø–∞–ø–æ–∫: $deleted/$count"
    if $VERBOSE; then
        echo "–û–±—â–∏–π –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π –æ–±—ä–µ–º: $(numfmt --to=iec-i --suffix=B --format="%.2f" $((total_size * 1024)))"
    fi
fi

exit 0
